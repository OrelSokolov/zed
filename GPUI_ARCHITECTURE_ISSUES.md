# –ü—Ä–æ–±–ª–µ–º—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã GPUI, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–ª—è Ollama stream

## 1. –ë–ª–æ–∫–∏—Ä—É—é—â–∏–π `block_internal` —Å `parker.park()`

**–ú–µ—Å—Ç–æ**: `crates/gpui/src/executor.rs:451-490`

```rust
pub(crate) fn block_internal<Fut: Future>(...) {
    let parker = parking::Parker::new();
    // ...
    loop {
        match future.as_mut().poll(&mut cx) {
            Poll::Ready(result) => return Ok(result),
            Poll::Pending => {
                parker.park(); // –ë–õ–û–ö–ò–†–£–ï–¢ –ü–û–¢–û–ö!
            }
        }
    }
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**: 
- –ö–æ–≥–¥–∞ future –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `Poll::Pending` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ I/O), –ø–æ—Ç–æ–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ `parker.park()`
- –ü–æ—Ç–æ–∫ –ø—Ä–æ–±—É–∂–¥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ waker –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è (—á–µ—Ä–µ–∑ `unparker.unpark()`)
- –ï—Å–ª–∏ I/O –æ–ø–µ—Ä–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –û–°, waker –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è Ollama**:
- –ù–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ –Ω–∞–ø—Ä—è–º—É—é, —Ç–∞–∫ –∫–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ —Å —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º `read()`
- –ù–æ –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å, –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `block_internal` –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç Ollama

## 2. Foreground executor –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ

**–ú–µ—Å—Ç–æ**: `crates/gpui/src/app.rs:1520-1554`

```rust
pub fn spawn<AsyncFn, R>(&self, f: AsyncFn) -> Task<R> {
    self.foreground_executor.spawn(async move { f(&mut cx).await })
}
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –í—Å–µ foreground –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
- UI –æ–ø–µ—Ä–∞—Ü–∏–∏ –º–æ–≥—É—Ç –∑–∞–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã
- –ï—Å–ª–∏ –≥–ª–∞–≤–Ω—ã–π –ø–æ—Ç–æ–∫ –∑–∞–Ω—è—Ç —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–æ–º, —Å–µ—Ç–µ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∂–¥—É—Ç

**–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è Ollama**:
- –ù–ï —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ –Ω–∞–ø—Ä—è–º—É—é, —Ç–∞–∫ –∫–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
- –ù–æ –º–æ–∂–µ—Ç –≤–ª–∏—è—Ç—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π –æ—Ç Ollama –≤ UI

## 3. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ worker threads

**–ú–µ—Å—Ç–æ**: `crates/gpui/src/platform/linux/dispatcher.rs:48-88`

```rust
std::thread::spawn(move || {
    for runnable in receiver.iter() {  // –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–ê–Ø –û–ë–†–ê–ë–û–¢–ö–ê!
        runnable.run();  // –ï—Å–ª–∏ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è, –¥—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏ –∂–¥—É—Ç
    }
})
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –ö–∞–∂–¥—ã–π worker thread –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–¥–∞—á–∏ **–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ**
- –ï—Å–ª–∏ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞ I/O, –≤–µ—Å—å –ø–æ—Ç–æ–∫ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è
- –î—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ —ç—Ç–æ–º –ø–æ—Ç–æ–∫–µ –∂–¥—É—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä—É—é—â–µ–π –æ–ø–µ—Ä–∞—Ü–∏–∏

**–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è Ollama**:
- **–í–´–°–û–ö–ê–Ø!** –ï—Å–ª–∏ –≥–¥–µ-—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `background_executor` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Ollama stream, –∏ —Ç–∞–º –µ—Å—Ç—å –±–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å –¥—Ä—É–≥–∏–µ –∑–∞–¥–∞—á–∏
- –ù–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫, —Ç–∞–∫ —á—Ç–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤–ª–∏—è—Ç—å –Ω–∞–ø—Ä—è–º—É—é

## 4. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ worker threads

**–ú–µ—Å—Ç–æ**: `crates/gpui/src/platform/linux/dispatcher.rs:38-39`

```rust
let thread_count = std::thread::available_parallelism()
    .map_or(MIN_THREADS, |i| i.get().max(MIN_THREADS));
```

**–ü—Ä–æ–±–ª–µ–º–∞**:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ worker threads = `available_parallelism().max(2)`
- –ù–∞ 8-—è–¥–µ—Ä–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ = 8 –ø–æ—Ç–æ–∫–æ–≤
- –≠—Ç–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è I/O-bound –∑–∞–¥–∞—á, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è

**–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è Ollama**:
- **–í–´–°–û–ö–ê–Ø!** –ï—Å–ª–∏ –≤—Å–µ worker threads –∑–∞–Ω—è—Ç—ã, –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –∂–¥—É—Ç
- –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–¥–µ—Ä–∂–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π –æ—Ç Ollama
- –ù–æ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫, —Ç–∞–∫ —á—Ç–æ —ç—Ç–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –≤–ª–∏—è—Ç—å –Ω–∞–ø—Ä—è–º—É—é

## 5. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä—è–º–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å async I/O runtime

**–ü—Ä–æ–±–ª–µ–º–∞**:
- GPUI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `smol` –¥–ª—è async runtime
- –ù–æ –Ω–µ—Ç –ø—Ä—è–º–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å `epoll`/`IOCP` –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ I/O
- –ë–ª–æ–∫–∏—Ä—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–æ—Ç–æ–∫–∏

**–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è Ollama**:
- **–°–†–ï–î–ù–Ø–Ø** - –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π `read()` –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ, —Ç–∞–∫ —á—Ç–æ —ç—Ç–æ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞–ø—Ä—è–º—É—é
- –ù–æ –µ—Å–ª–∏ –±—ã –º—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ async I/O —á–µ—Ä–µ–∑ smol, —ç—Ç–æ –º–æ–≥–ª–æ –±—ã –ø–æ–º–æ—á—å

## –†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –Ω–∞—à–µ–π –ø—Ä–æ–±–ª–µ–º—ã

### 1. ‚úÖ –£–∂–µ —Å–¥–µ–ª–∞–Ω–æ: –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –≤–Ω–µ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ü–æ—Ç–æ–∫ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ `spawn_ollama_reader_thread()`
- –≠—Ç–æ –æ–±—Ö–æ–¥–∏—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å `block_internal` –∏ worker threads

### 2. ‚úÖ –£–∂–µ —Å–¥–µ–ª–∞–Ω–æ: CPU affinity
- –ü—Ä–∏–≤—è–∑–∫–∞ –ø–æ—Ç–æ–∫–∞ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —è–¥—Ä—É CPU
- –≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ —Å worker threads

### 3. ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞: –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –û–° –≤—Å–µ –µ—â–µ –≤–ª–∏—è–µ—Ç
- –î–∞–∂–µ —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º –ø–æ—Ç–æ–∫–æ–º, –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ CFS –º–æ–∂–µ—Ç –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ
- –≠—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—Ç 40-45–º—Å –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ `read()`

### 4. üîÑ –í–æ–∑–º–æ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ worker threads
- –ú–æ–∂–Ω–æ —É–º–µ–Ω—å—à–∏—Ç—å `thread_count` –≤ `LinuxDispatcher::new()`
- –≠—Ç–æ –æ—Å–≤–æ–±–æ–¥–∏—Ç CPU –¥–ª—è –Ω–∞—à–µ–≥–æ –ø–æ—Ç–æ–∫–∞
- –ù–æ —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –¥—Ä—É–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

### 5. üîÑ –í–æ–∑–º–æ–∂–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å async I/O —á–µ—Ä–µ–∑ smol
- –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ `smol::AsyncRead` –≤–º–µ—Å—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ `read()`
- –≠—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å smol's epoll
- –ù–æ —ç—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–ª–æ–∂–Ω–µ–µ –∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

## –í—ã–≤–æ–¥

–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ - **–ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –û–° (CFS)**, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç –ø—Ä–æ–±—É–∂–¥–µ–Ω–∏–µ –ø–æ—Ç–æ–∫–∞ –∏–∑-–∑–∞:
1. –ë–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Ç–æ–∫–æ–≤ –≤ Zed (~14-20)
2. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏–∏ –∑–∞ CPU –º–µ–∂–¥—É –ø–æ—Ç–æ–∫–∞–º–∏
3. –û—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ —É –Ω–∞—à–µ–≥–æ –ø–æ—Ç–æ–∫–∞ (—Ç—Ä–µ–±—É–µ—Ç root)

–†–µ—à–µ–Ω–∏—è –±–µ–∑ root:
- ‚úÖ CPU affinity (—É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ)
- ‚úÖ –û—Ç–¥–µ–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫ –≤–Ω–µ async –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—É–∂–µ —Å–¥–µ–ª–∞–Ω–æ)
- üîÑ –£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ worker threads (–º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å)
- üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `ionice` –¥–ª—è I/O –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (–º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å)
